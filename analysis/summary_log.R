#
# Reads log files generated by bw_from_clat tool (under /bin).
#
# To use:
#   s <- read_summary_log("summary.log")
#   summary(s)
#   ss <- summarize_summary_log(s)
#   iops_summary_bars(ss)
#

library("ggplot2")
source("fio_log_parsers.R")

#
# Take summary log file from read_summary_log() and generate further
# summarization of rate, IOPS.
#
summarize_summary_log <- function(df) {
  collapsed_df <- NULL

  for (d in levels(df[,"dir"])) {
    for (b in levels(df[,"block_size"])) {
      subset <- df[df[,"block_size"] == b & df[,"dir"] == d,]
    
      summary <- data.frame(
        block_size = b,
        dir = d,
        rate_min = min(subset$rate),
        rate_mean = mean(subset$rate),
        rate_sd = sd(subset$rate),
        iops_min = min(subset$iops),
        iops_mean = mean(subset$iops),
        iops_sd = sd(subset$iops))

      if (is.null(collapsed_df)) {
        collapsed_df <- summary      
      } else {
        collapsed_df <- rbind(collapsed_df, summary)
      }
    }
  }

  return(collapsed_df)
}

#
# Bar chart of IOPS mean and standard error.
#
iops_summary_bars <- function(summary_df) {
  p <- ggplot(summary_df) +
    aes(block_size, iops_mean) +
    xlab("Block Size (b)") +
    ylab("IOPS") +
    scale_x_discrete(
      breaks = c(512, 2048, 16384, 65536, 262144, 1048576),
      labels = c("512", "2K", "16K", "64K", "256K", "1M")) +
    scale_y_continuous() +
    facet_grid(. ~ dir) +
    geom_bar(alpha = I(1/2)) +
    geom_errorbar(aes(ymin = iops_mean - iops_sd, ymax = iops_mean + iops_sd))
    
  return(p)
}
